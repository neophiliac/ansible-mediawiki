# =============================================================================
#
# - Copyright (C) 2016     George Li <yongxinl@outlook.com>
#
# - This is part of HomeVault imagebuilder project.
# - This program is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
#
# =============================================================================

---
- name: install required {{ ansible_distribution }} packages
  package: 
    name: "{{ item }}"
    state: present
  register: install_pkgs
  until: install_pkgs|success
  retries: 2
  delay: 5
  with_items: "{{ mediawiki_base_packages }}"

- name: create {{ install_role_name }} root directory
  file:
    path: "{{ mediawiki_root.split('/')[0:-1]|join('/') }}"
    state: directory
    mode: 0644

- name: clone {{ install_role_name }} core from repository
  git:
    repo: "https://gerrit.wikimedia.org/r/p/mediawiki/core.git"
    dest: "{{ mediawiki_root }}"
    version: "{{ mediawiki_version }}"
    depth: 1
    force: yes

- name: download php composer (required by {{ install_role_name }})
  get_url:
    url: "https://getcomposer.org/installer"
    dest: "{{ mediawiki_root }}/composer-setup.php"

- name: install php composer (required by {{ install_role_name }})
  command: "{{ item }} chdir={{ mediawiki_root }}"
  with_items:
    - php composer-setup.php
    - php -r "unlink('composer-setup.php');"

- name: clone vendor from {{ install_role_name }} repository
  command:  "{{ item }}
            chdir={{ mediawiki_root }}"
  with_items:
    - php {{ mediawiki_root }}/composer.phar install --no-dev

- name: clone skins from {{ install_role_name }} repository
  git:
    repo: "https://gerrit.wikimedia.org/r/p/mediawiki/skins/{{ item.name }}.git"
    dest: "{{ mediawiki_root }}/skins/{{ item.name }}"
    version: "{{ mediawiki_version }}"
    depth: 1
    force: yes
  with_items: "{{ mediawiki_core_skins }}"

- name: clone skins from 3rd-party repository
  git:
    repo: "{{ item.repo }}"
    dest: "{{ mediawiki_root }}/skins/{{ item.name }}"
    version: "{{ item.version }}"
    depth: 1
    force: yes
  with_items: "{{ mediawiki_3rdparty_skins }}"

- name: clone extension from {{ install_role_name }} repository
  git:
    repo: "https://gerrit.wikimedia.org/r/p/mediawiki/extensions/{{ item.name }}.git"
    dest: "{{ mediawiki_root }}/extensions/{{ item.name }}"
    version: "{{ mediawiki_version }}"
    depth: 1
    force: yes
  with_flattened:
    - "{{ mediawiki_core_extensions }}"
    - "{{ mediawiki_uncore_extensions }}"

- name: clone extension from 3rd-party repository
  git:
    repo: "{{ item.repo }}"
    dest: "{{ mediawiki_root }}/extensions/{{ item.name }}"
    version: "{{ item.version }}"
    depth: 1
    force: yes
  with_items: "{{ mediawiki_3rdparty_extensions }}"

- name: initialize {{ install_role_name }} extension and submodule
  command: "git submodule update --init
            chdir={{ mediawiki_root }}/extensions/{{ item.name }}"
  with_flattened:
    - "{{ mediawiki_core_extensions }}"
    - "{{ mediawiki_uncore_extensions }}"

- name: initialize {{ install_role_name }} extension and submodule
  command: "php {{ mediawiki_root }}/composer.phar install
            chdir={{ mediawiki_root }}/extensions/{{ item.name }}"
  with_items: "{{ mediawiki_extension_dependency }}"

- name: clone CKeditor from 3rd-party repository
  git:
    repo: "{{ item.repo }}"
    dest: "{{ mediawiki_root }}/extensions/{{ item.name }}"
    version: "{{ item.version }}"
    depth: 1
    force: yes
  with_items: "{{ mediawiki_Editor_CKeditor }}"
  when: mediawiki_editor == 'CKeditor'

- name: update CKeditor extension
  command: "{{ item }}
            chdir={{ mediawiki_root }}/extensions"
  with_items:
    - mv {{ mediawiki_root }}/extensions/WYSIWYG-CKeditor/WYSIWYG {{ mediawiki_root }}/extensions
    - rm -rf {{ mediawiki_root }}/extensions/WYSIWYG-CKeditor
    - rm -rf {{ mediawiki_root }}/extensions/WYSIWYG/ckeditor_source
  when: mediawiki_editor == 'CKeditor'

- name: clone VisualEditor from {{ install_role_name }} repository
  git:
    repo: "{{ item.repo }}"
    dest: "{{ mediawiki_root }}/extensions/{{ item.name }}"
    version: "{{ item.version|default(mediawiki_version) }}"
    depth: 1
    force: yes
  with_items: "{{ mediawiki_Editor_VisualEditor }}"
  when: mediawiki_editor == 'VisualEditor'

- name: initialize {{ install_role_name }} parsoid service
  command:  "{{ item }}
            chdir={{ mediawiki_root }}/extensions/parsoid"
  with_items:
    - npm install
  when: mediawiki_editor == 'VisualEditor'

- name: remove .git recursively from installation
  shell:  "{{ item }}
          chdir={{ mediawiki_root }}"
  with_items:
    - "find . | grep .git | xargs rm -rf"
  when: mediawiki_remove_git

- name: cleanup {{ install_role_name }} installation
  shell:  "{{ item }}
          chdir={{ mediawiki_root }}"
  with_items:
    - rm -f COPYING CREDITS FAQ HISTORY INSTALL README README.mediawiki RELEASE-NOTES-1.{{ mediawiki_version.split('_')[1] }} UPGRADE
    - rm -rf docs tests
    - find {{ mediawiki_root }}/languages/i18n/ -type f -not \( -iname 'en*' -or -iname 'zh*' \) | xargs rm -f
    - find . -print | while read filename; do touch -d 'Oct 1 2016' "$filename"; done